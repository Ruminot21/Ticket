{% extends 'mi_fuego/my_tickets/index.html' %}
{% load static %}
{% block truecontent %}
  {% if not tickets_dto and not transferred_dto %}
    <div class="truecontent">
      <div class="card text-center mx-extra">
        <div class="card-body d-flex justify-content-between flex-column align-items-center main-card-spacing gap-4">
          <h3>No tenés bonos transferibles</h3>
            {% if has_available_tickets %}
              <a class="btn btn-primary" href="{% url "select_tickets" %}">Comprar Bono</a>
            {% endif %}
        </div>
      </div>
    </div>
  {% else %}
    <div class="card transferable">
      <div class="card-header filters" role="group" aria-label="Filtros">
        <button type="button"
                class="active"
                data-filter="all"
                onclick="filterTickets('all', this)">Todos</button>
        <button type="button"
                data-filter="pending"
                onclick="filterTickets('pending', this)">Pendientes</button>
        <button type="button"
                data-filter="not-pending"
                onclick="filterTickets('not-pending', this)">Sin Asignar</button>
        <button type="button"
                data-filter="complete"
                onclick="filterTickets('complete', this)">Transferencia Completa</button>
      </div>
      <div class="p-0">
        <table class="table table-hover mb-0">
          <thead>
            <tr>
              <th>Bono</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for ticket in tickets_dto %}
              <tr class="ticket-row {% if ticket.is_transfer_pending %}pending{% else %}not-pending{% endif %}">
                <td>
                     <span class="badge bg-info text-black text-wrap">
                    {{ ticket.ticket_type }}
                     </span>
                </td>
                <td>
                  {% if ticket.is_transfer_pending %}
                    <span class="badge bg-warning text-black text-wrap">
                      Invitación pendiente a {{ ticket.transferring_to }}
                    </span>
                  {% else %}
                    <span class="badge bg-secondary text-wrap">
                      Sin asignar
                    </span>
                  {% endif %}
                </td>

                <td class="align-middle">
                  {% if ticket.is_transfer_pending %}
                    {% if event.transfer_period %}
                      <button class="btn btn-sm btn-danger"
                              onclick="cancelTicketTransfer('{{ ticket.key }}')">
                              <i class="fa-solid fa-xmark"></i>
                        Cancelar invitación

                      </button>
                    {% endif %}
                  {% else %}
                    {% if event.transfer_period %}
                      <button class="btn btn-sm btn-info"
                              data-bs-toggle="modal"
                              data-bs-target="#transferModal"
                              onclick="setTransferTicketId('{{ ticket.key }}')">
                              <i class="fa-regular fa-paper-plane"></i>
                        Transferir

                      </button>
                      {% if not my_ticket %}
                        <a class="btn btn-success btn-sm"
                           href="{% url 'assign_ticket' ticket.key %}">
                           <i class="fa-solid fa-person-walking-arrow-loop-left"></i>
                          Re-Asignarmelo

                        </a>
                      {% endif %}
                    {% endif %}
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
            {% for ticket in transferred_dto %}
              <tr class="ticket-row complete">
                <td>
                    <span class="badge bg-info text-black text-wrap">
                         {{ ticket.ticket_type }}
                     </span>
                </td>
                <td>
                  <span class="badge bg-success text-wrap">
                    Transferencia completa a {{ ticket.tx_to_email }}
                  </span>
                </td>
                <td></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}

  <!-- Transfer Modal -->
  <div class="modal fade"
       id="transferModal"
       data-bs-backdrop="static"
       tabindex="-1"
       aria-labelledby="transferModalLabel"
       aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header justify-content-center">
          <h1 class="modal-title" id="transferModalLabel">Transferir Bono</h1>
        </div>
        <div class="modal-body">
          <div id="transferForm">
            <div class="alert alert-warning text-start" role="alert">
              <strong>¡Atención!</strong>
              Si el destinatario no tiene cuenta en FA, se enviara una invitacion pero la transferencia no
              estara completa <strong>hasta que no se cree su cuenta.</strong>
            </div>
            <div class="mb-3 form-label text-start d-flex flex-column">
              <label for="recipient-email" class="form-label">Correo Electrónico del Destinatario</label>
              <input type="email"
                     class="form-control"
                     id="recipient-email"
                     placeholder="nombre@ejemplo.com">
              <div class="invalid-feedback">Por favor, ingresa un correo electrónico válido.</div>
            </div>
            <div class="modal-footer justify-content-center">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="button" class="btn btn-primary" onclick="confirmTransfer()">Confirmar</button>
            </div>
          </div>
          <div id="loadingSpinner"
               class="flex-column justify-content-center align-items-center"
               style="display: none">
            <div class="spinner-border text-primary" role="status"></div>
            <div class="my-4">Enviando...</div>
          </div>
          <div id="transferSuccessMessage" style="display: none;">
            <div class="alert alert-success">
              <h5>¡Felicidades!</h5>
              <div>El bono ha sido transferido con éxito.</div>
            </div>
            <button type="button" class="btn btn-primary" onclick="refreshPage()">Continuar</button>
          </div>
          <div id="transferPendingMessage" style="display: none;">
            <div class="alert alert-warning">
              <h5>¡Atencion!</h5>
              <div class="mb-2">
                Se envio una invitacion a
                <strong id="invitation-email"></strong>.
                Hasta que no se cree su cuenta, la
                transferencia no estara completa.
              </div>
            </div>
            <button type="button" class="btn btn-primary" onclick="refreshPage()">Continuar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function filterTickets(filter, btn) {
      const rows = document.querySelectorAll('.ticket-row');
      const buttons = document.querySelectorAll('.filters button');

      rows.forEach(row => {
        if (filter === 'all') {
          row.style.display = '';
        } else if (filter === 'pending' && row.classList.contains('pending')) {
          row.style.display = '';
        } else if (filter === 'not-pending' && row.classList.contains('not-pending')) {
          row.style.display = '';
        } else if (filter === 'complete' && row.classList.contains('complete')) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });

      buttons.forEach(button => {
        if (filter === button.dataset.filter) {
          button.classList.add('active');
        } else {
          button.classList.remove('active');
        }
      });
    }

    let transferTicketId = null;

    function setTransferTicketId(ticketId) {
      transferTicketId = ticketId;
      document.getElementById('recipient-email').value = '';
      document.getElementById('recipient-email').classList.remove('is-invalid');
      document.getElementById('transferForm').style.display = 'block';
      document.getElementById('loadingSpinner').style.display = 'none';
      document.getElementById('transferSuccessMessage').style.display = 'none';
      document.getElementById('transferPendingMessage').style.display = 'none';
    }

    function validateEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    async function confirmTransfer() {
      const emailInput = document.getElementById('recipient-email');
      const email = emailInput.value.trim();

      if (!validateEmail(email)) {
        emailInput.classList.add('is-invalid');
        return;
      }

      emailInput.classList.remove('is-invalid');
      document.getElementById('transferForm').style.display = 'none';
      document.getElementById('loadingSpinner').style.display = 'flex';

      try {
        const response = await fetch('/mi-fuego/mis-bonos/transferir/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify({
            ticket_key: transferTicketId,
            email: email
          })
        });

        if (response.ok) {
          const data = await response.json();
          document.getElementById('loadingSpinner').style.display = 'none';

          if (data.status === 'pending') {
            document.getElementById('invitation-email').textContent = email;
            document.getElementById('transferPendingMessage').style.display = 'block';
          } else {
            document.getElementById('transferSuccessMessage').style.display = 'block';
          }
        } else {
          throw new Error('Network response was not ok');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Hubo un error al procesar tu solicitud. Por favor, intenta nuevamente.');
        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('transferForm').style.display = 'block';
      }
    }

    async function cancelTicketTransfer(ticketKey) {
      if (!confirm('¿Estás seguro que querés cancelar la transferencia?')) {
        return;
      }

      try {
        const response = await fetch('/mi-fuego/mis-bonos/cancelar-transferencia/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify({
            ticket_key: ticketKey
          })
        });

        if (response.ok) {
          location.reload();
        } else {
          throw new Error('Network response was not ok');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Hubo un error al procesar tu solicitud. Por favor, intenta nuevamente.');
      }
    }

    function refreshPage() {
      location.reload();
    }
  </script>
{% endblock truecontent %}
